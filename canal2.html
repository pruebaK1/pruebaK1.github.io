<!DOCTYPE html>
<html>
<head>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: black;
}

#video {
    width: 100%;
    height: 100%;
    background: black;
}
</style>
</head>

<body>

<video id="video" controls autoplay muted></video>

<script>
// ===== CONFIG =====
let RELOAD_FREEZE_TIME = 10000; // 10s sin avanzar = reload
let FORCE_RELOAD_EVERY = 5 * 60 * 1000; // 5 min preventivo

// Obtener ?r=
function getParam(name) {
    return new URLSearchParams(window.location.search).get(name);
}

let encoded = getParam("r");
if (!encoded) {
    document.body.innerHTML = "NO PARAM r=";
    throw "No param";
}

// Base64 fix
encoded = encoded.replace(/-/g, '+').replace(/_/g, '/');
while (encoded.length % 4) encoded += '=';

// Decode
let url = atob(encoded);
console.log("STREAM:", url);

let video = document.getElementById("video");
let hls;
let lastTime = 0;
let lastUpdate = Date.now();

// Load HLS
function loadStream() {
    console.log("Reloading stream...");
    if (hls) hls.destroy();
    
    if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
    } else if (Hls.isSupported()) {
        hls = new Hls({
            maxBufferLength: 30,
            liveSyncDuration: 3
        });
        hls.loadSource(url);
        hls.attachMedia(video);
    }

    video.play().catch(()=>{});
    lastUpdate = Date.now();
}

loadStream();

// Detect time update (video running)
video.addEventListener("timeupdate", function() {
    if (video.currentTime !== lastTime) {
        lastTime = video.currentTime;
        lastUpdate = Date.now();
    }
});

// Detect freeze
setInterval(function() {
    let now = Date.now();
    if (!video.paused && (now - lastUpdate > RELOAD_FREEZE_TIME)) {
        console.log("FREEZE DETECTED -> RELOAD");
        loadStream();
    }
}, 2000);

// Detect error
video.addEventListener("error", function() {
    console.log("VIDEO ERROR -> RELOAD");
    loadStream();
});

// Forced reload
setInterval(loadStream, FORCE_RELOAD_EVERY);
</script>

</body>
</html>
